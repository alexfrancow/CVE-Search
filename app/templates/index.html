{% extends "layout.html" %}
{% block title %}CVE-Search{% endblock %}
{% block content %}

{% if new_cve %}
<div class="alert alert-dismissible alert-success">
  <button type="button" class="close" data-dismiss="alert">&times;</button>
  <strong>Well done!</strong> You successfully add {{ new_cve }}</a>.
</div>
{% endif %}

<nav class="navbar">
    <h1>CVE-S3arch</h1>
    <p class="nav navbar-nav navbar-right"><a href="https://twitter.com/alexfrancow" style="font-size:20px;"><img src="https://pbs.twimg.com/profile_images/1135232338508623873/KDGVryRs_400x400.png" height="50px" width="50px" style="border-radius: 50%;"/> @alexfrancow</a></p>
</nav>
<main id="cve-main">
  <nav id="cve-nav" class="rounded border-tw">
    <ul class="list-group">
    {% for row in rows %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <a href="?cve={{ row[0]}}">{{ row[0]}}</a>
        <a href="/run?cve={{ row[0]}}" class="ml-auto pr-3"><i class="fas fa-play" aria-hidden="true"></i></a>
        <a href="/delete?cve={{ row[0]}}"><i id="delete-icon" class="delete-icon fas fa-trash-alt" aria-hidden="true" style="display: none;"></i></a>
      </li>
    {% endfor %}
      <form id="CVEForm" style="margin-top: 20px;display:none;" action="/createCVE" method="post">
        <div class="input-group mb-3">
          <input type="text" class="form-control" name="cve" placeholder="CVE-XXXX-XXXX" aria-label="CVE-XXXX-XXXX" aria-describedby="basic-addon2" pattern="CVE-\d{4}-\d{4,7}">
          <div class="input-group-append">
            <input type="submit" value="Save CVE" class="input-group-text btn-primary" id="basic-addon2"></input>
          </div>
        </div>
      </form>

      <button onclick="openCVEForm()" id="add-cve" class="btn btn-default" style="vertical-align: middle;background-color: #77b300;color: white;">
        <i class="fas fa-plus"></i>
      </button>
      <button onclick="deleteMode()" id="delete-mode" class="btn btn-default" style="vertical-align: middle;background-color: #e02342;color: white;">
        <i class="fas fa-trash-alt"></i>
      </button>
    </ul>

 
  </nav>
  <header id="cve-info" class="rounded border-tw"> 
    <h2 id="cve-title">{{ cve }}</h2>
    <p>{{ description }}</p>

    <h5>Timeseries plot for this vulnerability</h5>

    <div class="container" id="CVETimeseriesDiv">
    <canvas id="line-chart" width="500" height="150"></canvas>
    </div>


    
    <p>Google Links:</p>
    <table class="table table-hover">
	{% for gL in googleLinks %}
        <tr class="table-info">   
          <td><a href="{{ gL }}">{{ gL }}</a></td>
	  <td>INFO/Posible Exploit</td>
	</tr>
        {% endfor %}
    </table>

    <div id="cve-table"> </div>
    <small>*Description ref: <a href="https://nvd.nist.gov/vuln/detail/{{ cve }}">https://nvd.nist.gov/vuln/detail/{{ cve }}</a></small>
  </header> 
  <section id="cve-renderLink" class="rounded border-tw">
    <h2>Streaming Data</h2>
  </section>
</main>


<script>
function deleteMode() {
  var x = document.getElementById("delete-icon");
  if (x.style.display === "none") {
    x.style.display = "block";
  } else {
    x.style.display = "none";
  }
}
</script>

<script type="text/javascript">
function grab(){
  $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
  $CVE = document.getElementById("cve-title").textContent;
  return new Promise((resolve, reject) => {
    $.ajax({
      url: $SCRIPT_ROOT+"/tweetsjson?cve="+$CVE, 
      method: "GET",
      dataType: "JSON",
      success: function(data){
        resolve(data)
      },
      error: function(error){
        reject(error);
      }
    })
  })
}

$(document).ready(function() {
  grab().then((data) => {

    console.log(data);

    let dates = [];
    let likes_volume = [];
    let tweet_volume = [];
    let retweets_volume = [];
    let max_tweets = [];
    data.dates.forEach(item => dates.push(item));
    data.likes_volume.forEach(item => likes_volume.push(item));
    data.tweet_volume.forEach(item => tweet_volume.push(item));
    data.retweets_volume.forEach(item => retweets_volume.push(item));
    data.max_tweets.forEach(item => max_tweets.push(item));

    var ctx = document.getElementById("line-chart"); ctx.style.backgroundColor = 'rgba(255,255,255,255)';
    new Chart(document.getElementById("line-chart"), {
      type: 'line',
      data: {
      labels: dates,
      datasets: [{ 
        data: tweet_volume,
        label: "Tweets Volume",
        borderColor: "#3e95cd",
        fill: false
        }, { 
        data: likes_volume,
        label: "Likes Volume",
        borderColor: "#8e5ea2",
        fill: false
        }, {
        data: retweets_volume,
        label: "Retweets Volume",
        borderColor: "#3cba9f",
        fill: false
        }
      ],
      max_tweet: max_tweets,
    },
    options: {
      tooltips: {
      callbacks: {
        label: function(tooltipItem, max_tweet) {
          var maxTweet = max_tweet.max_tweet[tooltipItem.index];
          return  maxTweet;
        }
      }},
      title: {
        display: true,
        text: 'Timeseries plot for {{ cve }}'
      },
      events: ['click'],
      scales: {
        yAxes: [{
          scaleLabel: {
            display: true,
            labelString: 'NÂº Tweets'
          }
        }],
        xAxes: [{
          scaleLabel: {
            display: true,
            labelString: 'Date (%Y-%m-%d)'
          }
        }]
      }
    }
  })
})
});

</script>
{% endblock %} {% block footer %} {% endblock %}
